<!DOCTYPE HTML>
<html>
	<head>
		<title>beta-即时消息系统</title>
		<meta charset="utf-8" />
		<link href="css/chat.css" type="text/css" rel="stylesheet">
		<link href="css/jquery-plugin-v1.0.0.css" type="text/css" rel="stylesheet">
		<link href="js/treeview/treeview.css" type="text/css" rel="stylesheet">
	</head>
	<body>
		<div class="container">
			<!--联系人-->
			<div class="contact">
				<!--搜索框-->
				<div class="search-box">
					<div class="search">
						<i class="chat-icon search-icon"></i>
						<input type="text" class="search-contact" placeholder="搜索" />
					</div>
					<!--搜索结果-->
					<div class="search-result">
						<!-- <p><img class="avatar" src="./default_34_34.jpg" width="22px">陈明</p>
						<p><img class="avatar no-login" src="./default_34_34.jpg" width="22px">陈明</p>
						<p><img class="avatar" src="./default_34_34.jpg" width="22px">陈明</p>
						<p><img class="avatar" src="./default_34_34.jpg" width="22px">陈明</p>
						<p><img class="avatar" src="./default_34_34.jpg" width="22px">陈明</p>
						<p><img class="avatar no-login" src="./default_34_34.jpg" width="22px">陈明</p>
						<p><img class="avatar" src="./default_34_34.jpg" width="22px">陈明</p>
						<p><img class="avatar" src="./default_34_34.jpg" width="22px">陈明</p>-->
					</div>
				</div>
				<!--联系人tab页-->
				<div class="contact-type">
					<div class="tab active" tab-name="recent" type="default">最近联系人</div>
					<div class="tab" tab-name="structure">组织架构</div>
				</div>
				<!--最近联系人-->
				<div id="nearest-contact" class="tab-detail recent active">
					<div class="tree-folders"></div>
					<!-- <div class="tree-folders">
						<span class="no-child" type="personal" data-id="xieyx"><img class="avatar no-login" src="./default_34_34.jpg" width="22px">谢衍鑫<b class="unread">9</b></span>
                        <span class="no-child" type="personal"><img class="avatar no-login" src="./default_34_34.jpg" width="22px">刘书<b class="unread">2</b></span>
						<span type="group" data-id="cuihb-liushu-chenming">
							<div class="group-avatar">
								<img class="avatar" src="./default_34_34.jpg" width="10px">
								<img class="avatar no-login" src="./default_34_34.jpg" width="10px">
								<img class="avatar" src="./default_34_34.jpg" width="10px">
								<img class="avatar" src="./default_34_34.jpg" width="10px">
							</div>
							陈明、刘书
							<b class="unread">99</b>
						</span>
						<span type="group" data-id="cuihb-liushu-chenming">
							<div class="group-avatar">
								<img class="avatar" src="./default_34_34.jpg" width="10px">
								<img class="avatar no-login" src="./default_34_34.jpg" width="10px">
								<img class="avatar" src="./default_34_34.jpg" width="10px">
								<img class="avatar" src="./default_34_34.jpg" width="10px">
							</div>
							陈明、刘书
							<b class="unread">99</b>
						</span>
					</div> 
					<div class="tree-files">
						<span class="no-child" type="member" data-id="chenming"><img class="avatar no-login" src="./default_34_34.jpg" width="22px">陈明</span>
                        <span class="no-child" type="member" data-id="cuihb"><img class="avatar no-login" src="./default_34_34.jpg" width="22px">崔洪波</span>
					</div>
					<div class="tree-files">
						<span class="no-child" type="member" data-id="chenming"><img class="avatar no-login" src="./default_34_34.jpg" width="22px">陈明</span>
                        <span class="no-child" type="member" data-id="cuihb"><img class="avatar no-login" src="./default_34_34.jpg" width="22px">崔洪波</span>
					</div>-->
				</div>
				<!--组织架构-->
				<div id="organization-structure" class="tab-detail structure">
					<div class="tree-folders">
						<span>管理层</span>
						<span>战略发展与投资部</span>
						<span class="no-child">视频部</span>
						<span class="no-child">技术部</span>
						<span>广告销售部</span>
						<span class="no-child">人力资源部</span>
                    </div>
					<div class="tree-files">
						<span class="no-child" type="member" data-id="chenming"><img class="avatar" src="./default_34_34.jpg" width="22px">陈明</span>
                       	<span class="no-child" type="member" data-id="liushu"><img class="avatar no-login" src="./default_34_34.jpg" width="22px">刘书</span>
                       	<span class="no-child" type="member" data-id="andyxu"><img class="avatar" src="./default_34_34.jpg" width="22px">徐进</span>
                       	<span class="no-child" type="member" data-id="bettyho"><img class="avatar" src="./default_34_34.jpg" width="22px">何晔</span>
                    </div>
                    <div class="tree-files">
						<div class="tree-folders">
							<span>战略BD组</span>
							<span class="no-child">创新产品组</span>
						</div>
						<div class="tree-files">
							<span class="no-child"><img class="avatar" src="./default_34_34.jpg" width="22px">邓少玮</span>
                            <span class="no-child"><img class="avatar" src="./default_34_34.jpg" width="22px">刘鼎森</span>
						</div>
                    </div>
                    <div class="tree-files">
						<div class="tree-folders">
							<span class="no-child"><img class="avatar" src="./default_34_34.jpg" width="22px">范丽茜</span>
							<span>华北区</span>
						</div>
						<div class="tree-files">
							<div class="tree-folders">
								<span class="no-child"><img class="avatar" src="./default_34_34.jpg" width="22px">池小燕</span>
								<span>华北业务管理部</span>
							</div>
							<div class="tree-files">
								<div class="tree-folders">
									<span class="no-child"><img class="avatar" src="./default_34_34.jpg" width="22px">卑晓艳</span>
									<span>华北媒介部</span>
									<span>内容产品中心</span>
								</div>
								<div class="tree-files">
									<span class="no-child"><img class="avatar" src="./default_34_34.jpg" width="22px">解丹</span>
								</div>
								<div class="tree-files">
									<span class="no-child"><img class="avatar" src="./default_34_34.jpg" width="22px">宫昊源</span>
								</div>
							</div>
						</div>
                     </div>
				</div>
				<div class="tool">
                    <i class="chat-icon broadcast show-modal" modal-title="广播消息" modal-data="broadcastlist.html"><i class="notice"></i></i>
                    <div class="pop-broadcast">
                        <a href="javascript:;" class="tips-close button-close">×</a>
                        <p class="tit text-cut show-modal" modal-title="广播消息" modal-data="broadcastlist.html"></p>
                        <p class="con show-modal" modal-title="广播消息" modal-data="broadcastlist.html"></p>
                    </div>
                </div>
			</div>
			<!--聊天详情-->
			<div class="detail">
				<!--当前联系人信息-->
				<div class="contact-msg" chatid="">
					<h1>进展如何了</h1>
					<p>谢衍鑫创建于2016-01-08 12:15:10</p>
					<div class="contact-tool">
						<i class="chat-icon add-group show-modal" modal-title="添加群成员" modal-data="addgroup.html"></i>
					</div>
				</div>
				<div class="chat-box">
					<!--联系人群组成员-->
					<!--<div class="member">
						<div class="tree-folders">
							<span type="group">
								陈明、刘书
							</span>
						</div>
						<div class="tree-files">
							<span class="no-child" type="member"><img class="avatar" src="./default_34_34.jpg" width="22px">陈明</span>
                        	<span class="no-child" type="member"><img class="avatar no-login" src="./default_34_34.jpg" width="22px">刘书</span>
						</div>
					</div>-->
					<div class="message">
						<!--历史消息-->
						<div class="logs">
							<div class="row">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>崔洪波 - 2016-01-08 12:16:11</p>
									<div class="message-box">
										wget http://sourceforge.net/projects/levent/files/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz/download
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<div class="row self">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>&nbsp;</p>
									<div class="message-box">
										wget http://sourceforge.net/projects/levent/files/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz/download
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>崔洪波 - 2016-01-08 12:16:11</p>
									<div class="message-box">
										wget http://sourceforge.net/projects/levent/files/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz/download
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>崔洪波 - 2016-01-08 12:16:11</p>
									<div class="message-box">
										wget http://sourceforge.net/projects/levent/files/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz/download
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>崔洪波 - 2016-01-08 12:16:11</p>
									<div class="message-box">
										wget http://sourceforge.net/projects/levent/files/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz/download
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>崔洪波 - 2016-01-08 12:16:11</p>
									<div class="message-box">
										wget http://sourceforge.net/projects/levent/files/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz/download
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>崔洪波 - 2016-01-08 12:16:11</p>
									<div class="message-box">
										wget http://sourceforge.net/projects/levent/files/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz/download
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>崔洪波 - 2016-01-08 12:16:11</p>
									<div class="message-box">
										wget http://sourceforge.net/projects/levent/files/release-2.0.22-stable/libevent-2.0.22-stable.tar.gz/download
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>崔洪波 - 2016-01-08 12:16:11</p>
									<div class="message-box">
										<img src="images/demo.jpg" width=100%/>
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<div class="row">
								<div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div>
								<div class="message-detail">
									<p>崔洪波 - 2016-01-08 12:16:11</p>
									<div class="message-box">
										<div class="files">
											<div class="file-msg">
												<p>会议.docx</p>
												<p>10.5kb</p>
											</div>
											<div class="attach-upload">
												<div class="progress"></div>
												<div class="loaded"></div>
												<div class="attach-upload-control"><i class="attach-upload-start"></i><i class="attach-upload-stop"></i><i class="attach-upload-end"></i><i class="attach-upload-close"></i><span>0%</span></div>
											</div>
											<div class="file-tool">
												<a href="javascript:;">保存</a>
											</div>
										</div>
										<i class="chat-icon message-box-pike"></i>
									</div>
								</div>
							</div>
							<!--系统消息-->
							<div class="row system">
  								<span>孙霆邀请了侯玉魁加入群聊孙霆邀请了侯玉魁加入群聊孙霆邀请了侯玉魁加入群聊孙霆邀请了侯玉魁加入群聊孙霆邀请了侯玉魁加入群聊孙霆邀请了侯玉魁加入群聊孙霆邀请了侯玉魁加入群聊孙霆邀请了侯玉魁加入群聊孙霆邀请了侯玉魁加入群聊</span>
							</div>
						</div>
						<!--消息发送-->
						<div class="send-msg">
							<div class="tool">
								<a class="chat-icon smile" href="javascript:;"></a>
								<i class="chat-icon image show-modal" modal-title="上传图片" modal-data="upload-new.html"></i>
								<i class="chat-icon attach"></i>
<!-- 								<i class="chat-icon audio"></i>-->	
 							<i class="chat-icon remind"></i>
								<i class="chat-icon history show-modal" modal-title="聊天记录" modal-data="history.html"></i>
								<input type="file" name="attach" style="width:0;height:0;float:left;" />
								<div class="pop-smiley" id="demo">
									<a href="javascript:;" data-face="face0" title="微笑"></a>	
									<a href="javascript:;" data-face="face1" title="撇嘴"></a>	
									<a href="javascript:;" data-face="face2" title="色"></a>	
									<a href="javascript:;" data-face="face3" title="发呆"></a>	
									<a href="javascript:;" data-face="face4" title="得意"></a>	
									<a href="javascript:;" data-face="face5" title="流泪"></a>	
									<a href="javascript:;" data-face="face6" title="害羞"></a>	
									<a href="javascript:;" data-face="face7" title="闭嘴"></a>	
									<a href="javascript:;" data-face="face8" title="睡"></a>	
									<a href="javascript:;" data-face="face9" title="大哭"></a>	
									<a href="javascript:;" data-face="face10" title="尴尬"></a>	
									<a href="javascript:;" data-face="face11" title="发怒"></a>	
									<a href="javascript:;" data-face="face12" title="调皮"></a>	
									<a href="javascript:;" data-face="face13" title="龇牙"></a>	
									<a href="javascript:;" data-face="face14" title="惊讶"></a>	
									<a href="javascript:;" data-face="face15" title="难过"></a>	
									<a href="javascript:;" data-face="face16" title="酷"></a>	
									<a href="javascript:;" data-face="face17" title=""></a>	
									<a href="javascript:;" data-face="face18" title=""></a>	
									<a href="javascript:;" data-face="face19" title=""></a>	
									<a href="javascript:;" data-face="face20" title=""></a>	
									<a href="javascript:;" data-face="face21" title=""></a>	
									<a href="javascript:;" data-face="face22" title=""></a>	
									<a href="javascript:;" data-face="face23" title=""></a>	
									<a href="javascript:;" data-face="face24" title=""></a>	
									<a href="javascript:;" data-face="face25" title=""></a>	
									<a href="javascript:;" data-face="face26" title=""></a>	
									<a href="javascript:;" data-face="face27" title=""></a>	
									<a href="javascript:;" data-face="face28" title=""></a>	
									<a href="javascript:;" data-face="face29" title=""></a>	
									<a href="javascript:;" data-face="face30" title=""></a>	
									<a href="javascript:;" data-face="face31" title=""></a>	
									<a href="javascript:;" data-face="face32" title=""></a>	
									<a href="javascript:;" data-face="face33" title=""></a>	
									<a href="javascript:;" data-face="face34" title=""></a>	
									<a href="javascript:;" data-face="face35" title=""></a>	
									<a href="javascript:;" data-face="face36" title=""></a>	
									<a href="javascript:;" data-face="face37" title=""></a>	
									<a href="javascript:;" data-face="face38" title=""></a>	
									<a href="javascript:;" data-face="face39" title=""></a>	
									<a href="javascript:;" data-face="face40" title=""></a>	
									<a href="javascript:;" data-face="face41" title=""></a>	
									<a href="javascript:;" data-face="face42" title=""></a>	
									<a href="javascript:;" data-face="face43" title=""></a>	
									<a href="javascript:;" data-face="face44" title=""></a>	
									<a href="javascript:;" data-face="face45" title=""></a>	
									<a href="javascript:;" data-face="face46" title=""></a>	
									<a href="javascript:;" data-face="face47" title=""></a>	
									<a href="javascript:;" data-face="face48" title=""></a>	
									<a href="javascript:;" data-face="face49" title=""></a>	
									<a href="javascript:;" data-face="face50" title=""></a>	
									<a href="javascript:;" data-face="face51" title=""></a>	
									<a href="javascript:;" data-face="face52" title=""></a>	
									<a href="javascript:;" data-face="face53" title=""></a>	
									<a href="javascript:;" data-face="face54" title=""></a>	
									<a href="javascript:;" data-face="face55" title=""></a>	
									<a href="javascript:;" data-face="face56" title=""></a>	
									<a href="javascript:;" data-face="face57" title=""></a>	
									<a href="javascript:;" data-face="face58" title=""></a>	
									<a href="javascript:;" data-face="face59" title=""></a>	
									<a href="javascript:;" data-face="face60" title=""></a>	
									<a href="javascript:;" data-face="face61" title=""></a>	
									<a href="javascript:;" data-face="face62" title=""></a>	
									<a href="javascript:;" data-face="face63" title=""></a>	
									<a href="javascript:;" data-face="face64" title=""></a>	
									<a href="javascript:;" data-face="face65" title=""></a>	
									<a href="javascript:;" data-face="face66" title=""></a>	
									<a href="javascript:;" data-face="face67" title=""></a>	
									<a href="javascript:;" data-face="face68" title=""></a>	
									<a href="javascript:;" data-face="face69" title=""></a>	
									<a href="javascript:;" data-face="face70" title=""></a>	
									<a href="javascript:;" data-face="face71" title=""></a>	
									<a href="javascript:;" data-face="face72" title=""></a>	
									<a href="javascript:;" data-face="face73" title=""></a>	
									<a href="javascript:;" data-face="face74" title=""></a>	
									<a href="javascript:;" data-face="face75" title=""></a>	
									<a href="javascript:;" data-face="face76" title=""></a>	
									<a href="javascript:;" data-face="face77" title=""></a>	
									<a href="javascript:;" data-face="face78" title=""></a>	
									<a href="javascript:;" data-face="face79" title=""></a>	
									<a href="javascript:;" data-face="face80" title=""></a>	
									<a href="javascript:;" data-face="face81" title=""></a>	
									<a href="javascript:;" data-face="face82" title=""></a>	
									<a href="javascript:;" data-face="face83" title=""></a>	
									<a href="javascript:;" data-face="face84" title=""></a>	
									<a href="javascript:;" data-face="face85" title=""></a>	
									<a href="javascript:;" data-face="face86" title=""></a>	
									<a href="javascript:;" data-face="face87" title=""></a>	
									<a href="javascript:;" data-face="face88" title=""></a>	
									<a href="javascript:;" data-face="face89" title=""></a>	
									<a href="javascript:;" data-face="face90" title=""></a>	
									<a href="javascript:;" data-face="face91" title=""></a>	
									<a href="javascript:;" data-face="face92" title=""></a>	
									<a href="javascript:;" data-face="face93" title=""></a>	
									<a href="javascript:;" data-face="face94" title=""></a>	
									<a href="javascript:;" data-face="face95" title=""></a>	
									<a href="javascript:;" data-face="face96" title=""></a>	
									<a href="javascript:;" data-face="face97" title=""></a>	
									<a href="javascript:;" data-face="face98" title=""></a>	
									<a href="javascript:;" data-face="face99" title=""></a>	
									<a href="javascript:;" data-face="face100" title=""></a>	
									<a href="javascript:;" data-face="face101" title=""></a>	
									<a href="javascript:;" data-face="face102" title=""></a>	
									<a href="javascript:;" data-face="face103" title=""></a>	
									<a href="javascript:;" data-face="face104" title=""></a>	
								</div>
							</div>
							<!--消息输入框-->
							<div class="chat-input" id="chat-input" contenteditable="true" spellcheck="false"></div>
							<!--消息发送按钮-->
							<div class="send-button">
								<a href="javascript:;" class="chat-icon more">&nbsp;</a>
								<a href="javascript:;" class="chat-icon button send">发送</a>
								<div class="pop-keys">
									<p data-keys="return" class="active">按Enter键发送消息</p>
									<p data-keys="Ctrl+return">按Ctrl+Enter键发送消息</p>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="home"></div>
			</div>
		</div>
        <div class="pop-groupName">
            <a href="javascript:;" class="tips-close button-close">&times;</a>
            <input type="text" name="groupName">
        </div>
        <audio id="chat-audio" src="audio/system.wav" display="none"></audio>
		<script src="js/jquery.min.js"></script>
		<script src="js/jquery-plugin-v1.0.0.js"></script>
		<script src="js/jquery.hotkeys.js"></script>
		<script src="js/pasteimage.js"></script>
		<script src="js/common.js"></script>
		<script type="text/javascript" src="./js/chat.js"></script>
		<script type="text/javascript" src="./js/chatlazy.js"></script>
		<script src="js/main.js"></script>
        <script src="js/treeview/treeview.js"></script>
        <script src="js/libs/jquery.lazyload.js?v=1.9.3"></script>
        <script src="js/uploader.js"></script>
		<script>
			function fileSizeFormat(size, dec) {
				size = size||0;
				dec = dec||2;
    				var unit = ["B", "KB", "MB", "GB", "TB", "PB"];
    				var pos = 0;
    				while (size >= 1024) {
        				size /= 1024;
        				pos++;
    				}
				return size.toFixed(dec)+unit[pos]
			}
			function fileIcon(type) {
				var typeLimit = [
					'aep','ai','as','avi','css','doc','eps',
					'epub','fla','flv','gif','html','indd','jpg',
					'js','midi','mkv','mov','mp3','mp4','mpg',
					'ogg','otf','pdf','php','png','psd','rar',
					'rtf','svg','swc','swf','tif','ttf','txt',
					'wav','wma','wmv','xls','xml','zip'
				];
				var typeReplace = {
					'docx':'doc','xlsx':'xls','pptx':'ppt'
				};
				if(type in typeReplace) {
					return typeReplace[type];
				}else{
					for(var x in typeLimit) {
						if(typeLimit[x] == type)
							return type
					}
				}
				return 'blanc';
			}
			function hotkeysbind(event){
				$('.send').click();
				return false;
			}
			function systemLogs(msg) {
				$('.logs').append('<div class="row system"><span>'+msg+'</span></div>');
			}
		$(function(){
           function upload(formData, num, type){
                //最后一片不能暂停, 需要合并
                if(uploader.running.total - uploader.running.loaded < uploader.threadNum)
                    $('.logs .row.'+uploader.running.file.id).find('.attach-upload').remove().end().find('.file-tool').html('即将上传完毕').show();
                //暂停用
                if(type != 'http')
                uploader.running.chunks[num] = {'start':uploader.waitThread.start == null ? 0 : uploader.waitThread.start};
				uploader.running.chunks[num].ajax = $.ajax({
						url:'chatapi.php?c=file&a=chunk',
						data:formData,
						processData : false,
						contentType: false,
						dataType:'JSON',
						type:'POST',
						success:function(res){
                            if(res.data.type != 'complete') {
                                uploader.persentages[uploader.running.file.id].loaded += uploader.chunkSize;
                                var percent = Math.round(uploader.persentages[uploader.running.file.id].loaded/uploader.persentages[uploader.running.file.id].total*100);
                                $('.logs .row.'+uploader.running.file.id).find('.loaded-persent').html(percent+'%').end().find('.loaded').css('width',percent/100*200);
                                uploader.chunk(uploader.running.file,function(file, index){
                                    var formData = new FormData();
                                    formData.append('file', file);
                                    formData.append('name', uploader.running.name);
                                    formData.append('index', index);
                                    formData.append('total', uploader.running.total);
                                    upload(formData, num);
                                });
                            }else{
                                uploader.persentages[uploader.running.file.id].loaded = uploader.persentages[uploader.running.file.id].total;
                                $('.logs .row.'+uploader.running.file.id).find('.loaded-persent').html('100%').end().find('.loaded').css('width',200);
                                var filename = res.data.filepath.replace(/[^/]*\//g, '');
                                var filemd5 = '';
                                $('.logs .row.'+uploader.running.file.id).find('.attach-upload').remove().end().find('.file-tool').html('<a href="/chatapi.php?c=file&a=download&srcname='+uploader.running.file.name+'&desname='+filename+'" data-name="'+filename+'">保存</a>').show();
                                sendToWsMsg('<div class="files">'+$('.logs .row.'+uploader.running.file.id+' .files').html()+'</div>', "file", filemd5);
                                $('.logs .row.'+uploader.running.file.id).remove();
                                send();
                            }
                        }
					})
            }
            function send() {
                if(uploader.pending.length == 0) {
                    return
                }
                uploader.waitThread = {};
                uploader.running = uploader.pending[0];
                uploader.pending.splice(0,1);
                uploader.running.chunks = [];
                uploader.running.total = Math.ceil(uploader.running.file.size/uploader.chunkSize);
                uploader.running.name = uploader.running.file.name+'|'+uploader.running.file.type+'|'+uploader.running.file.size+'|'+wc_loginName;
                $('.logs .row.'+uploader.running.file.id).find('.attach-upload').show().end().find('.file-tool').hide();
                for(var i=0; i<uploader.threadNum && i<uploader.running.total; i++) {
                    uploader.chunk(uploader.running.file,function(file, index){
                        var formData = new FormData();
                        formData.append('file', file);
                        formData.append('name', uploader.running.name);
                        formData.append('index', index);
                        formData.append('total', uploader.running.total);
                        upload(formData, i);
                    });
                }
            }
                $('.logs').on('click', '.attach-upload-stop', function(){
                    $(this).hide().siblings('.attach-upload-start').show();
                    uploader.stop();
                })
                $('.logs').on('click', '.attach-upload-start', function(){
                    $(this).hide().siblings('.attach-upload-stop').show();
                    //重发断点
                    uploader.http(function(file, index, x){
                        var formData = new FormData();
                        formData.append('file', file);
                        formData.append('name', uploader.running.name);
                        formData.append('index', index);
                        formData.append('total', uploader.running.total);
                        upload(formData, x, 'http');
                    })
                })
				$(document).on('click','.show-modal',function(){
					$(this).modal();
				})
				$('.pop-keys p').click(function(){
					$(this).addClass('active').siblings().removeClass('active');
					$('.chat-input').unbind('keydown',hotkeysbind)
					$('.chat-input').bind('keydown',$('.pop-keys .active').attr('data-keys'),hotkeysbind)
					writeCookie('sendMsghk',$('.pop-keys .active').attr('data-keys'), 60);
				});
				if(readCookie('sendMsghk')) {
					$('.pop-keys p').removeClass('active');
					$('.pop-keys p[data-keys="'+readCookie('sendMsghk')+'"]').addClass('active');
				}
				$('.chat-input').bind('keydown',readCookie('sendMsghk') || $('.pop-keys .active').attr('data-keys'),hotkeysbind)
				$('.attach').click(function(){
					$('input[name=attach]').click();
				})
				$('input[name=attach]').change(function(e){
					e = e || window.event;
					var target = e.target;
					var file = target.files[0];
                    file = uploader.fileMSG(file);
                    file.chatid = getNowChatId();
                    uploader.pending.push({'file':file});
                    $('.logs').append('<div class="row self '+file.id+'"><div class="user-avatar"><img class="avatar" src="./default_34_34.jpg"></div><div class="message-detail"><p>&nbsp;</p><div class="message-box"><div class="files"><div class="file-msg" style="background-image:url(./images/filetype/icon_'+fileIcon(file.ext.toLowerCase())+'_256.png)"><p class="text-cut">'+file.name+'</p><p>'+fileSizeFormat(file.size)+'</p></div><div class="attach-upload" style="display:none"><div class="progress"></div><div class="loaded"></div><div class="attach-upload-control"><i class="attach-upload-start"></i><i class="attach-upload-stop"></i><i class="attach-upload-end"></i><i class="attach-upload-close"></i><span class="loaded-persent">0%</span></div></div><div class="file-tool">等待上传</div></div><i class="chat-icon message-box-pike"></i></div></div></div>').scrollToBottom();
                    if(uploader.running == null || (uploader.running && uploader.persentages[uploader.running.file.id].total == uploader.persentages[uploader.running.file.id].loaded))
                        send();
				});
			})
		</script>
		<script>
			var global_range=null;
			var obj = document.getElementById('chat-input');
			obj.setAttribute('oninput',document.all && !document.documentMode ? eval(function(){updateRange()}) : 'javascript:updateRange()');
            obj.setAttribute('onpropertychange',document.all && !document.documentMode ? eval(function(){updateRange()}) : 'javascript:updateRange()');
			obj.setAttribute('onclick',document.all && !document.documentMode ? eval(function(){updateRange()}) : 'javascript:updateRange()')
        	function updateRange(){
				if (window.getSelection){ 
					var sel = window.getSelection();
         			global_range = sel.getRangeAt(0);
				}
            }
			function cursorControl(a){
				this.element=a;
				this.range=!1;
				this.start=0;
				this.init();
			};
			cursorControl.prototype={
				init:function(){
					var _that=this;
					this.element.onkeyup=this.element.onmouseup=function(){
						this.focus();
						if(document.all){
							_that.range=document.selection.createRange();
						}else{
							_that.start=_that.getStart();
						}
					}
				},
				getType:function(){
					return Object.prototype.toString.call(this.element).match(/^\[object\s(.*)\]$/)[1];
				},
				getStart:function(){
					if (this.element.selectionStart || this.element.selectionStart == '0'){  
						return this.element.selectionStart; 
					}else if (window.getSelection){  
						var rng = window.getSelection().getRangeAt(0).cloneRange();  
						rng.setStart(this.element,0);  
						return rng.toString().length;
					}
				},
				insertText:function(text){
					this.element.focus();  
					if (document.all){
						var a = document.selection.createRange();  
						document.selection.empty();  
						a.pasteHTML(text); 
						a.collapse();  
						a.select();  
					}else{
						var start=this.getStart();
						if(this.getType()=='HTMLDivElement'){
							this.element.innerHTML=this.element.innerHTML.substr(0,start)+text+this.element.innerHTML.substr(start);
						}else{
							this.element.value=this.element.value.substr(0,start)+text+this.element.value.substr(start);
						}  
					} 
				}
			}; 
			function fn(id,str){
				if (window.getSelection){ 
					// IE9 and non-IE 
					sel = window.getSelection();
					if (sel.getRangeAt && sel.rangeCount) {	
						range = sel.getRangeAt(0);
						if(range.endContainer.id != id && range.endContainer.parentNode.id != id)
							range = global_range;
						if(range == null)
							return false;	
						range.deleteContents(); 
						var el = document.createElement('div'); 
						el.innerHTML = str; 
						var frag = document.createDocumentFragment(), node, lastNode; 
						while ( (node = el.firstChild) ) { 
							lastNode = frag.appendChild(node); 
						} 
						range.insertNode(frag); 
						if (lastNode) { 
							range = range.cloneRange(); 
							range.setStartAfter(lastNode); 
							range.collapse(true); 
							sel.removeAllRanges(); 
							sel.addRange(range); 
						}
						global_range = range;
					} 
				}else{ 
					var cc=new cursorControl(document.getElementById(id));
					cc.insertText(str);
				}
			};
		</script>
	</body>
</html>
